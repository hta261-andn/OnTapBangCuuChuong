<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>√îN LUY·ªÜN - B·∫¢NG C·ª¨U CH∆Ø∆†NG</title>
  <style>
    :root{
      --bg:#0b1020; --muted:#9fb0ff; --text:#e8ecff;
      --btn:#5b7cfa; --btn2:#33406b; --ok:#2ecc71; --bad:#ff5b6e;
      --line: rgba(255,255,255,.12);
      --chip: rgba(255,255,255,.06);
      --chipOn: rgba(91,124,250,.22);
      --chipBorder: rgba(255,255,255,.14);
      --chipBorderOn: rgba(91,124,250,.65);
      --warn:#ffcc66;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: radial-gradient(1200px 600px at 20% 0%, #182454 0%, var(--bg) 55%);
      color:var(--text); min-height:100vh; display:flex; align-items:center; justify-content:center;
      padding:16px;
    }
    .app{
      width:min(1000px, 100%);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border:1px solid var(--line); border-radius:18px; padding:16px;
      box-shadow: 0 18px 60px rgba(0,0,0,.35);
    }
    h1{margin:0 0 10px; font-size:20px}
    .grid{display:grid; grid-template-columns: 1.12fr .88fr; gap:12px}
    @media (max-width:820px){ .grid{grid-template-columns:1fr} }
    .card{
      background:rgba(0,0,0,.18);
      border:1px solid var(--line);
      border-radius:16px;
      padding:14px;
    }
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .muted{color:var(--muted); font-size:13px}
    .pill{
      display:inline-flex; align-items:center; gap:8px; padding:8px 10px; border-radius:999px;
      background:rgba(255,255,255,.05); border:1px solid var(--line);
      font-size:13px; white-space:nowrap;
    }

    .tablesLine{
      margin-top:6px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      font-weight:800;
    }
    .tablesLine b{color:#fff}
    .tablesWrap{ display:flex; flex-wrap:wrap; gap:10px; margin-top:10px; }
    label.tableBtn{
      display:inline-flex; align-items:center; justify-content:center;
      min-width:92px;
      padding:12px 12px;
      border-radius:14px;
      background:var(--chip);
      border:1px solid var(--chipBorder);
      cursor:pointer; user-select:none;
      font-weight:900;
      -webkit-tap-highlight-color: transparent;
    }
    label.tableBtn input{ position:absolute; opacity:0; width:1px; height:1px; pointer-events:none; }
    label.tableBtn.on{
      background:var(--chipOn);
      border-color:var(--chipBorderOn);
      box-shadow: 0 0 0 4px rgba(91,124,250,.14);
    }

    .controls{
      display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:12px;
    }
    @media (max-width:520px){ .controls{grid-template-columns:1fr} }
    .selectWrap{
      background:rgba(255,255,255,.05);
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px;
    }
    .selectWrap .lbl{font-size:12px; color:var(--muted); margin-bottom:6px; font-weight:800}
    select, input[type="text"]{
      width:100%; padding:10px 10px; border-radius:10px;
      border:1px solid var(--line); background:rgba(0,0,0,.25); color:var(--text);
      outline:none;
    }
    select:focus, input[type="text"]:focus{
      border-color: rgba(91,124,250,.8); box-shadow:0 0 0 4px rgba(91,124,250,.18);
    }

    .bar{
      height:10px; border-radius:999px; border:1px solid var(--line); overflow:hidden;
      background:rgba(0,0,0,.20);
    }
    .bar > div{
      height:100%; width:0%;
      background: linear-gradient(90deg, rgba(91,124,250,.95), rgba(46,204,113,.85));
    }

    .btns{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px}
    button{
      border:0; cursor:pointer; padding:10px 14px; border-radius:12px; font-weight:900;
      color:white; background:var(--btn2);
    }
    button.primary{ background:var(--btn); }
    button.danger{ background:#d94b57; }
    button:disabled{ opacity:.5; cursor:not-allowed; }

    .quiz{display:flex; flex-direction:column; gap:10px;}
    .problem{
      font-size:42px; letter-spacing:.5px; text-align:center;
      padding:18px 10px; border-radius:16px;
      background:rgba(255,255,255,.05); border:1px solid var(--line);
    }
    .answerRow{display:flex; gap:10px; justify-content:center; flex-wrap:wrap; align-items:center}
    input[type="number"]{
      width:220px; max-width:100%;
      padding:12px 12px; border-radius:12px; border:1px solid var(--line);
      background:rgba(0,0,0,.25); color:var(--text); font-size:18px;
      outline:none;
    }
    input[type="number"]:focus{ border-color: rgba(91,124,250,.8); box-shadow:0 0 0 4px rgba(91,124,250,.18); }

    .status{ text-align:center; min-height:22px; font-weight:900; letter-spacing:.3px; }
    .status.ok{ color:var(--ok); }
    .status.bad{ color:var(--bad); }
    .status.warn{ color:var(--warn); }
    .status.late{ color:#ffcc66; }

    .keypad{
      margin-top:8px;
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:10px;

      /* ‚úÖ nh·ªè ~90% */
      transform: scale(0.9);
      transform-origin: top center;
    }
    .key{
      padding:13px 0;      /* tr∆∞·ªõc 14px */
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      color:var(--text);
      font-size:17px;      /* tr∆∞·ªõc 18px */
      font-weight:900;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
    }
    .key:active{ transform: scale(0.98); }
    .key.secondary{ background:rgba(255,255,255,.04); }

    table{width:100%; border-collapse:collapse; font-size:14px}
    th, td{ padding:10px 8px; border-bottom:1px solid var(--line); text-align:left; vertical-align:top}
    th{ color:var(--muted); font-weight:900 }
    .right{ text-align:right }
    .center{ text-align:center }
    .tag{
      display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; font-weight:900;
      border:1px solid var(--line); background:rgba(255,255,255,.04)
    }
    .tag.ok{ color:var(--ok); border-color: rgba(46,204,113,.35) }
    .tag.bad{ color:var(--bad); border-color: rgba(255,91,110,.35) }
    .tag.warn{ color:var(--warn); border-color: rgba(255,204,102,.45) }

    .footerNote{margin-top:10px; font-size:12px; color:var(--muted)}
    .finalMsg{
      margin-top:10px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      font-weight:800;
      line-height:1.45;
    }
    .finalMsg b{color:#fff}
  </style>
</head>
<body>
  <div class="app">
    <h1>√în luy·ªán B·∫£ng C·ª≠u ch∆∞∆°ng [H√Ä TR∆Ø∆†NG C√ÅT NG·ªåC]</h1>

    <div class="grid">
      <!-- LEFT -->
      <div class="card">
        <div class="row" style="justify-content:space-between">
          <div class="muted" style="font-weight:800">Ch·ªçn b·∫£ng ƒë·ªÉ luy·ªán</div>
          <div class="pill">
            <span>√Çm thanh:</span>
            <label style="display:flex; gap:6px; align-items:center; cursor:pointer">
              <input type="checkbox" id="soundToggle" checked />
              <span>B·∫≠t</span>
            </label>
          </div>
        </div>

        <div class="tablesLine" id="selectedLine">C√°c b·∫£ng ƒë√£ ch·ªçn: <b>2, 3, 4, 5, 6, 7, 8, 9</b></div>
        <div class="tablesWrap" id="tablesWrap"></div>

        <div class="controls">
          <div class="selectWrap">
            <div class="lbl">T√™n h·ªçc sinh</div>
            <input id="studentName" type="text" placeholder="V√≠ d·ª•: B·∫°n An" />
          </div>

          <div class="selectWrap">
            <div class="lbl">Th·ªùi gian t·ªïng</div>
            <select id="timeSelect">
              <option value="3">3 ph√∫t</option>
              <option value="5">5 ph√∫t</option>
              <option value="10">10 ph√∫t</option>
              <option value="15">15 ph√∫t</option>
              <option value="20">20 ph√∫t</option>
            </select>
          </div>

          <div class="selectWrap">
            <div class="lbl">Ch·∫ø ƒë·ªô ph√©p t√≠nh</div>
            <select id="modeSelect">
              <option value="mix">Nh√¢n & chia (ng·∫´u nhi√™n)</option>
              <option value="mul">Luy·ªán ph√©p t√≠nh NH√ÇN</option>
              <option value="div">Luy·ªán ph√©p t√≠nh CHIA</option>
            </select>
          </div>

          <div class="selectWrap">
            <div class="lbl">Gi·ªõi h·∫°n t√≠nh ƒëi·ªÉm m·ªói c√¢u</div>
            <select id="qLimitSelect">
              <option value="0" selected>Kh√¥ng gi·ªõi h·∫°n</option>
              <option value="3">3 gi√¢y</option>
              <option value="5">5 gi√¢y</option>
              <option value="7">7 gi√¢y</option>
              <option value="9">9 gi√¢y</option>
            </select>
          </div>

          <div class="selectWrap" style="grid-column:1 / -1">
            <div class="lbl">Ti·∫øn ƒë·ªô th·ªùi gian</div>
            <div class="bar"><div id="timeBar"></div></div>
            <div class="row" style="margin-top:8px; justify-content:flex-start">
              <div class="pill"><span>ƒê√£ l√†m:</span> <b id="countDone">0</b></div>
              <div class="pill"><span>Trong gi·ªù:</span> <b id="countScored">0</b></div>
              <div class="pill"><span>ƒê√∫ng:</span> <b id="countOK">0</b></div>
              <div class="pill"><span>Sai:</span> <b id="countBad">0</b></div>
              <div class="pill"><span>%:</span> <b id="livePct">0%</b></div>
              <div class="pill"><span>C√≤n:</span> <b id="timeLeft">--:--</b></div>
            </div>
          </div>
        </div>

        <div class="footerNote">
          ‚ÄúGi·ªõi h·∫°n t√≠nh ƒëi·ªÉm m·ªói c√¢u‚Äù: n·∫øu tr·∫£ l·ªùi <b>qu√° th·ªùi gian</b> th√¨ v·∫´n ƒë∆∞·ª£c l√†m ti·∫øp,
          nh∆∞ng <b>ƒë∆∞·ª£c t√≠nh nh∆∞ 01 c√¢u SAI</b> trong k·∫øt qu·∫£ chung.
        </div>

        <div id="resultBox" style="display:none; margin-top:14px">
          <div id="finalMsg" class="finalMsg" style="display:none"></div>

          <div class="row" style="justify-content:space-between; margin:10px 0">
            <div class="pill"><span>T·ªïng ƒë√£ l√†m:</span> <b id="totalQ">0</b></div>
            <div class="pill"><span>Trong gi·ªù:</span> <b id="totalScored">0</b></div>
            <div class="pill"><span>ƒê√∫ng:</span> <b id="totalOK">0</b></div>
            <div class="pill"><span>T·ª∑ l·ªá:</span> <b id="percent">0%</b></div>
          </div>

          <div style="overflow:auto; border-radius:14px; border:1px solid var(--line)">
            <table>
              <thead>
                <tr>
                  <th style="width:54px">#</th>
                  <th>Ph√©p t√≠nh</th>
                  <th class="right">B·∫°n tr·∫£ l·ªùi</th>
                  <th class="right">ƒê√°p √°n</th>
                  <th class="right" style="width:110px">Th·ªùi gian</th>
                  <th class="center" style="width:120px">Tr·∫°ng th√°i</th>
                  <th class="center" style="width:110px">KQ</th>
                </tr>
              </thead>
              <tbody id="resultBody"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- RIGHT -->
      <div class="card quiz">
        <div class="row" style="justify-content:space-between">
          <div class="pill"><span>Tr·∫°ng th√°i:</span> <b id="stateLabel">Ch∆∞a b·∫Øt ƒë·∫ßu</b></div>
          <div class="pill"><span>Ch·∫ø ƒë·ªô:</span> <b id="modeLabel">‚Äî</b></div>
          <div class="pill"><span>Th·ªùi gian tr·∫£ l·ªùi m·ªói c√¢u:</span> <b id="qLeft">--</b></div>
        </div>

        <!-- C·ª•m n√∫t ·ªü ph√≠a tr√™n ph√©p t√≠nh -->
        <div class="btns">
          <button class="primary" id="btnStart">B·∫Øt ƒë·∫ßu</button>
          <button class="danger" id="btnStop" disabled>K·∫øt th√∫c</button>
          <button id="btnReset">L√†m l·∫°i</button>
        </div>

        <div class="problem" id="problem">Ch·ªçn b·∫£ng v√† nh·∫•n ‚ÄúB·∫Øt ƒë·∫ßu‚Äù</div>

        <!-- ‚úÖ N√∫t OK ngang √¥ nh·∫≠p -->
        <div class="answerRow">
          <input id="answer" type="number" inputmode="numeric" placeholder="Nh·∫≠p k·∫øt qu·∫£‚Ä¶" disabled />
          <button id="btnOkTop" class="primary" disabled>OK</button>
        </div>

        <!-- ‚úÖ Keypad (kh√¥ng c√≥ n√∫t OK n·ªØa) -->
        <div class="keypad" id="keypad" aria-label="B√†n ph√≠m s·ªë">
          <button class="key" data-k="1" type="button">1</button>
          <button class="key" data-k="2" type="button">2</button>
          <button class="key" data-k="3" type="button">3</button>
          <button class="key" data-k="4" type="button">4</button>
          <button class="key" data-k="5" type="button">5</button>
          <button class="key" data-k="6" type="button">6</button>
          <button class="key" data-k="7" type="button">7</button>
          <button class="key" data-k="8" type="button">8</button>
          <button class="key" data-k="9" type="button">9</button>

          <button class="key secondary" data-action="clear" type="button">X√≥a</button>
          <button class="key" data-k="0" type="button">0</button>
          <button class="key secondary" data-action="back" type="button">‚Üê</button>
        </div>

        <div id="status" class="status"></div>
        <div class="muted" style="text-align:center">
          Nh·∫•n OK ho·∫∑c Enter ƒë·ªÉ qua c√¢u ti·∫øp theo.
        </div>
      </div>
    </div>
  </div>

<script>
(() => {
  // ---------- UI ----------
  const tablesWrap = document.getElementById('tablesWrap');
  const selectedLine = document.getElementById('selectedLine');

  const btnStart = document.getElementById('btnStart');
  const btnStop = document.getElementById('btnStop');
  const btnReset = document.getElementById('btnReset');
  const btnOkTop = document.getElementById('btnOkTop');

  const problemEl = document.getElementById('problem');
  const answerEl = document.getElementById('answer');
  const statusEl = document.getElementById('status');

  const countDoneEl = document.getElementById('countDone');
  const countScoredEl = document.getElementById('countScored'); // "Trong gi·ªù"
  const countOKEl = document.getElementById('countOK');
  const countBadEl = document.getElementById('countBad');
  const livePctEl = document.getElementById('livePct');

  const timeLeftEl = document.getElementById('timeLeft');
  const timeBarEl = document.getElementById('timeBar');

  const resultBox = document.getElementById('resultBox');
  const resultBody = document.getElementById('resultBody');
  const totalQEl = document.getElementById('totalQ');
  const totalScoredEl = document.getElementById('totalScored'); // "Trong gi·ªù"
  const totalOKEl = document.getElementById('totalOK');
  const percentEl = document.getElementById('percent');
  const finalMsgEl = document.getElementById('finalMsg');

  const studentNameEl = document.getElementById('studentName');

  const timeSelect = document.getElementById('timeSelect');     // minutes
  const modeSelect = document.getElementById('modeSelect');     // mix/mul/div
  const qLimitSelect = document.getElementById('qLimitSelect'); // 0/3/5/7/9 seconds
  const soundToggle = document.getElementById('soundToggle');

  const stateLabel = document.getElementById('stateLabel');
  const modeLabel = document.getElementById('modeLabel');
  const qLeftEl = document.getElementById('qLeft');

  const keypad = document.getElementById('keypad');

  // ---------- Build table buttons 2..9 ----------
  const tableItems = [];
  for (let n = 2; n <= 9; n++) {
    const label = document.createElement('label');
    label.className = 'tableBtn on';
    label.innerHTML = `<input type="checkbox" value="${n}" checked /><span>B·∫£ng ${n}</span>`;
    const input = label.querySelector('input');

    label.addEventListener('click', (e) => {
      e.preventDefault();
      if (input.disabled) return;
      input.checked = !input.checked;
      syncTableButtons();
    });

    tableItems.push({ n, input, label });
    tablesWrap.appendChild(label);
  }

  function selectedTables() {
    return tableItems.filter(x => x.input.checked).map(x => x.n);
  }

  function syncTableButtons() {
    for (const item of tableItems) item.label.classList.toggle('on', item.input.checked);
    const sel = selectedTables();
    selectedLine.innerHTML = sel.length
      ? `C√°c b·∫£ng ƒë√£ ch·ªçn: <b>${sel.join(', ')}</b>`
      : `C√°c b·∫£ng ƒë√£ ch·ªçn: <b>(ch∆∞a ch·ªçn b·∫£ng n√†o)</b>`;
  }

  // ---------- State ----------
  let running = false;
  let current = null;

  // history item:
  // { text, correct, user, okInTime, timeSec, inLimit }
  let history = [];
  let okCount = 0;      // ƒë√∫ng & trong gi·ªù (ho·∫∑c kh√¥ng gi·ªõi h·∫°n)
  let badCount = 0;     // sai (bao g·ªìm sai trong gi·ªù + qu√° gi·ªù)
  let inTimeCount = 0;  // s·ªë c√¢u "trong gi·ªù"

  // session timer
  let totalSeconds = 0;
  let secondsLeft = 0;
  let timerId = null;

  // question timing
  let qStartMs = 0;

  function getQuestionLimit() {
    const v = Number(qLimitSelect.value);
    return [0,3,5,7,9].includes(v) ? v : 0;
  }

  // ---------- Sound ----------
  let audioCtx = null;
  function ensureAudio(){ if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }

  function beepOk(){
    if(!soundToggle.checked) return;
    ensureAudio();
    const now = audioCtx.currentTime;
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.type = 'sine';
    osc.frequency.setValueAtTime(880, now);
    osc.frequency.exponentialRampToValueAtTime(1320, now + 0.08);
    gain.gain.setValueAtTime(0.0001, now);
    gain.gain.exponentialRampToValueAtTime(0.12, now + 0.01);
    gain.gain.exponentialRampToValueAtTime(0.0001, now + 0.14);
    osc.connect(gain); gain.connect(audioCtx.destination);
    osc.start(now); osc.stop(now + 0.16);
  }

  function beepBad(){
    if(!soundToggle.checked) return;
    ensureAudio();
    const now = audioCtx.currentTime;
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.type = 'square';
    osc.frequency.setValueAtTime(220, now);
    osc.frequency.exponentialRampToValueAtTime(160, now + 0.12);
    gain.gain.setValueAtTime(0.0001, now);
    gain.gain.exponentialRampToValueAtTime(0.14, now + 0.01);
    gain.gain.exponentialRampToValueAtTime(0.0001, now + 0.18);
    osc.connect(gain); gain.connect(audioCtx.destination);
    osc.start(now); osc.stop(now + 0.20);
  }

  function beepTimeUp(){
    if(!soundToggle.checked) return;
    ensureAudio();
    const now = audioCtx.currentTime;
    const playOne = (t, freq, dur=0.14) => {
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.type = 'triangle';
      osc.frequency.setValueAtTime(freq, t);
      gain.gain.setValueAtTime(0.0001, t);
      gain.gain.exponentialRampToValueAtTime(0.16, t + 0.01);
      gain.gain.exponentialRampToValueAtTime(0.0001, t + dur);
      osc.connect(gain); gain.connect(audioCtx.destination);
      osc.start(t); osc.stop(t + dur + 0.02);
    };
    playOne(now + 0.00, 780);
    playOne(now + 0.18, 520);
    playOne(now + 0.36, 320);
  }

  // ---------- Helpers ----------
  function randInt(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }
  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));
  }
  function fmtTime(sec){
    const m = Math.floor(sec/60), s = sec%60;
    return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
  }
  function round1(x){ return Math.round(x*10)/10; }

  // % = ƒë√∫ng (trong gi·ªù) / t·ªïng ƒë√£ l√†m
  function calcPct(){
    const done = history.length;
    return done === 0 ? 0 : Math.round((okCount / done) * 100);
  }

  function updateLiveStats(){
    const done = history.length;
    const pct = calcPct();
    countDoneEl.textContent = String(done);
    countScoredEl.textContent = String(inTimeCount);
    countOKEl.textContent = String(okCount);
    countBadEl.textContent = String(badCount);
    livePctEl.textContent = `${pct}%`;
  }

  function showStatus(msg, kind){
    statusEl.textContent = msg || '';
    statusEl.className = 'status' + (kind ? ` ${kind}` : '');
    if(msg){
      clearTimeout(showStatus._t);
      showStatus._t = setTimeout(() => showStatus('', ''), 900);
    }
  }

  function setRunningUI(on){
    running = on;
    btnStart.disabled = on;
    btnStop.disabled = !on;
    answerEl.disabled = !on;
    btnOkTop.disabled = !on;

    tableItems.forEach(x => x.input.disabled = on);
    timeSelect.disabled = on;
    modeSelect.disabled = on;
    qLimitSelect.disabled = on;
    studentNameEl.disabled = on;

    stateLabel.textContent = on ? 'ƒêang ch·∫°y' : (history.length ? 'ƒê√£ d·ª´ng' : 'Ch∆∞a b·∫Øt ƒë·∫ßu');

    if(on) resultBox.style.display = 'none';
    syncTableButtons();
  }

  function getMode(){
    const m = modeSelect.value;
    if(m === 'mul') return {key:'mul', label:'Ph√©p t√≠nh NH√ÇN'};
    if(m === 'div') return {key:'div', label:'Ph√©p t√≠nh CHIA'};
    return {key:'mix', label:'Nh√¢n & chia (ng·∫´u nhi√™n)'};
  }

  function generateQuestion(tables, modeKey){
    const ts = tables.length ? tables : [2,3,4,5,6,7,8,9];

    let opType;
    if(modeKey === 'mul') opType = 'mul';
    else if(modeKey === 'div') opType = 'div';
    else opType = (Math.random() < 0.55 ? 'mul' : 'div');

    const n = ts[randInt(0, ts.length-1)];
    const k = randInt(1, 10);

    if(opType === 'mul'){
      let a = n, b = k;
      if(Math.random() < 0.5){ const t=a; a=b; b=t; }
      return { text:`${a} √ó ${b} = ?`, correct: a*b };
    }else{
      const product = n*k;
      const divisor = (Math.random()<0.5) ? n : k;
      return { text:`${product} √∑ ${divisor} = ?`, correct: product/divisor };
    }
  }

  function updateQuestionTimerUI(){
    const limit = getQuestionLimit();
    if(!running){ qLeftEl.textContent = '--'; return; }
    qLeftEl.textContent = (limit > 0) ? `${limit}s` : '‚àû';
  }

  function nextQuestion(){
    const tables = selectedTables();
    const mode = getMode();
    current = generateQuestion(tables, mode.key);
    problemEl.textContent = current.text;
    answerEl.value = '';
    answerEl.focus();
    qStartMs = performance.now();
    updateQuestionTimerUI();
  }

  function recordAndMove(userValue){
    if(!running || !current) return;

    const limit = getQuestionLimit();
    const tSec = round1((performance.now() - qStartMs) / 1000);
    const inLimit = (limit === 0) ? true : (tSec <= limit);

    const user = (userValue === '' || userValue === null || userValue === undefined) ? null : Number(userValue);
    const isCorrect = (user !== null) && Number.isFinite(user) && (user === current.correct);

    // QUY T·∫ÆC:
    // - Qu√° gi·ªù: t√≠nh nh∆∞ 01 c√¢u SAI (d√π ƒë√∫ng)
    // - ƒê√∫ng ch·ªâ khi: ƒë√∫ng v√† trong gi·ªù (ho·∫∑c kh√¥ng gi·ªõi h·∫°n)
    const okInTime = isCorrect && inLimit;

    history.push({
      text: current.text.replace('= ?', '=').trim(),
      correct: current.correct,
      user,
      okInTime,
      timeSec: tSec,
      inLimit
    });

    if(inLimit) inTimeCount++;

    if(okInTime){
      okCount++;
      beepOk();
      showStatus('ƒê√öNG!', 'ok');
    }else{
      badCount++;
      if(limit > 0 && !inLimit && isCorrect){
        showStatus('‚è±Ô∏è ƒê√∫ng (ƒë√£ qu√° gi·ªù)', 'late');
      }else if(limit > 0 && !inLimit){
        showStatus('Sai', 'bad');
      }else{
        beepBad();
        showStatus('SAI!', 'bad');
      }
    }

    updateLiveStats();
    nextQuestion();
  }

  function submitAnswer(){
    if(!running || !current) return;
    recordAndMove(answerEl.value);
  }

  // ---------- Session timer ----------
  function stopTimer(){ if(timerId){ clearInterval(timerId); timerId = null; } }

  function updateTimerUI(){
    timeLeftEl.textContent = fmtTime(secondsLeft);
    if(totalSeconds > 0){
      const used = totalSeconds - secondsLeft;
      const pct = Math.min(100, Math.max(0, (used/totalSeconds)*100));
      timeBarEl.style.width = pct.toFixed(2) + '%';
    } else {
      timeBarEl.style.width = '0%';
    }
  }

  function startTimer(minutes){
    stopTimer();
    totalSeconds = Math.min(20, Math.max(3, Number(minutes))) * 60;
    secondsLeft = totalSeconds;
    updateTimerUI();

    timerId = setInterval(() => {
      if(!running) return;
      secondsLeft = Math.max(0, secondsLeft - 1);
      updateTimerUI();
      if(secondsLeft <= 0) finishSession(true);
    }, 1000);
  }

  function getEncouragement(pct){
    if(pct < 75){
      return { level:'Ch∆∞a ƒë·∫°t', msg:'C·∫ßn t·∫≠p trung v√† √¥n luy·ªán nhi·ªÅu h∆°n' };
    }
    if(pct >= 75 && pct < 80){
      return { level:'C∆° b·∫£n', msg:'C·ªë g·∫Øng h∆°n n·ªØa nh√©' };
    }
    if(pct >= 80 && pct <= 90){
      return { level:'Kh√°', msg:'C·ªë g·∫Øng th√™m ch√∫t n·ªØa' };
    }
    if(pct > 90 && pct <= 95){
      return { level:'T·ªët', msg:'G·∫ßn thu·ªôc h·∫øt r·ªìi, c·ªë l√™n, c·ªë l√™n' };
    }
    if(pct > 95 && pct < 100){
      return { level:'Xu·∫•t s·∫Øc', msg:'C·ªë g·∫Øng th√™m ch√∫t n·ªØa th√¥i l√† thu·ªôc 100% r·ªìi, C·ªë l√™n, C·ªë l√™n' };
    }
    return { level:'Tuy·ªát v·ªùi', msg:'B·∫°n ƒë√£ thu·ªôc 100% r·ªìi! Tuy·ªát v·ªùi l·∫Øm!' };
  }

  function renderResults(){
    const total = history.length;
    const pct = calcPct();

    totalQEl.textContent = String(total);
    totalScoredEl.textContent = String(inTimeCount);
    totalOKEl.textContent = String(okCount);
    percentEl.textContent = `${pct}%`;

    const nameRaw = (studentNameEl.value || '').trim();
    const name = nameRaw ? nameRaw : 'B·∫°n';
    const tables = selectedTables();
    const tablesText = tables.length ? tables.join(', ') : '2, 3, 4, 5, 6, 7, 8, 9';
    const { level, msg } = getEncouragement(pct);

    finalMsgEl.style.display = 'block';
    finalMsgEl.innerHTML = `
      <div><b>${escapeHtml(name)}</b> tr·∫£ l·ªùi ƒë√∫ng <b>${pct}%</b> - K·∫øt qu·∫£: <b>${escapeHtml(level)}</b></div>
      <div>Trong ph·∫°m vi B·∫£ng c·ª≠u ch∆∞∆°ng: <b>${escapeHtml(tablesText)}</b></div>
      <div style="margin-top:6px">üí° ${escapeHtml(msg)}</div>
      <div class="muted" style="margin-top:6px">
        L∆∞u √Ω: N·∫øu c√≥ gi·ªõi h·∫°n, c√¢u <b>qu√° gi·ªù</b> s·∫Ω <b>t√≠nh nh∆∞ 01 c√¢u SAI</b> trong k·∫øt qu·∫£ chung.
      </div>
    `;

    resultBody.innerHTML = '';
    const limit = getQuestionLimit();

    history.forEach((h, idx) => {
      const ans = (h.user === null) ? '<span class="muted">b·ªè tr·ªëng</span>' : h.user;
      const timeTxt = `${h.timeSec}s`;

      const statusTag = (limit > 0 && !h.inLimit)
        ? '<span class="tag warn">QU√Å GI·ªú (Kh√¥ng t√≠nh ƒëi·ªÉm)</span>'
        : '<span class="tag ok">TRONG GI·ªú</span>';

      const isOver = (limit > 0 && !h.inLimit);
      const userIsCorrect = (h.user !== null && Number.isFinite(h.user) && h.user === h.correct);

      const kqTag = isOver
        ? (userIsCorrect
            ? '<span class="tag ok">ƒê√öNG (Kh√¥ng t√≠nh ƒëi·ªÉm)</span>'
            : '<span class="tag bad">SAI</span>')
        : (h.okInTime
            ? '<span class="tag ok">ƒê√öNG</span>'
            : '<span class="tag bad">SAI</span>');

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${idx + 1}</td>
        <td>${escapeHtml(h.text)}</td>
        <td class="right">${ans}</td>
        <td class="right">${h.correct}</td>
        <td class="right">${timeTxt}</td>
        <td class="center">${statusTag}</td>
        <td class="center">${kqTag}</td>
      `;
      resultBody.appendChild(tr);
    });

    resultBox.style.display = 'block';
  }

  function finishSession(timeUp=false){
    if(!running) return;

    stopTimer();
    setRunningUI(false);

    problemEl.textContent = timeUp
      ? 'H·∫æT GI·ªú! Xem k·∫øt qu·∫£ ·ªü b·∫£ng th·ªëng k√™.'
      : 'ƒê√£ k·∫øt th√∫c. Xem k·∫øt qu·∫£ ·ªü b·∫£ng th·ªëng k√™.';

    answerEl.value = '';
    renderResults();

    if(timeUp){
      beepTimeUp();
      showStatus('H·∫øt gi·ªù!', 'bad');
    }
  }

  // ---------- Keypad ----------
  function appendDigit(d){
    if(answerEl.disabled) return;
    const cur = answerEl.value || '';
    if(cur.length >= 3) return;
    if(cur === '0') answerEl.value = String(d);
    else answerEl.value = cur + String(d);
    answerEl.focus();
  }
  function backspace(){
    if(answerEl.disabled) return;
    const cur = answerEl.value || '';
    answerEl.value = cur.slice(0, -1);
    answerEl.focus();
  }
  function clearAll(){
    if(answerEl.disabled) return;
    answerEl.value = '';
    answerEl.focus();
  }

  keypad.addEventListener('click', (e) => {
    const btn = e.target.closest('button');
    if(!btn) return;

    const k = btn.getAttribute('data-k');
    const action = btn.getAttribute('data-action');

    if(k !== null && k !== undefined){
      appendDigit(k);
      return;
    }
    if(action === 'back') backspace();
    else if(action === 'clear') clearAll();
  });

  // ---------- Events ----------
  btnStart.addEventListener('click', () => {
    const tables = selectedTables();
    if(tables.length === 0){
      showStatus('B·∫°n ch∆∞a ch·ªçn b·∫£ng n√†o.', 'bad');
      return;
    }

    history = [];
    current = null;
    okCount = 0;
    badCount = 0;
    inTimeCount = 0;

    updateLiveStats();
    resultBox.style.display = 'none';
    finalMsgEl.style.display = 'none';
    statusEl.textContent = '';

    const mode = getMode();
    modeLabel.textContent = mode.label;

    setRunningUI(true);
    startTimer(timeSelect.value);
    nextQuestion();
  });

  btnStop.addEventListener('click', () => finishSession(false));
  btnOkTop.addEventListener('click', submitAnswer);

  answerEl.addEventListener('keydown', (e) => {
    if(e.key === 'Enter'){
      e.preventDefault();
      submitAnswer();
    }
  });

  btnReset.addEventListener('click', () => {
    stopTimer();

    tableItems.forEach(x => x.input.disabled = false);

    running = false;
    current = null;
    history = [];
    okCount = 0;
    badCount = 0;
    inTimeCount = 0;
    updateLiveStats();

    problemEl.textContent = 'Ch·ªçn b·∫£ng v√† nh·∫•n ‚ÄúB·∫Øt ƒë·∫ßu‚Äù';
    answerEl.value = '';
    statusEl.textContent = '';

    tableItems.forEach(x => x.input.checked = true);
    syncTableButtons();

    studentNameEl.disabled = false; studentNameEl.value = '';
    timeSelect.disabled = false; timeSelect.value = '3';
    modeSelect.disabled = false; modeSelect.value = 'mix';
    qLimitSelect.disabled = false; qLimitSelect.value = '0';

    modeLabel.textContent = '‚Äî';
    stateLabel.textContent = 'Ch∆∞a b·∫Øt ƒë·∫ßu';
    timeLeftEl.textContent = '--:--';
    timeBarEl.style.width = '0%';
    qLeftEl.textContent = '--';

    resultBox.style.display = 'none';
    finalMsgEl.style.display = 'none';

    btnStart.disabled = false;
    btnStop.disabled = true;
    answerEl.disabled = true;
    btnOkTop.disabled = true;
  });

  // init
  btnStop.disabled = true;
  answerEl.disabled = true;
  btnOkTop.disabled = true;
  timeLeftEl.textContent = '--:--';
  qLeftEl.textContent = '--';
  stateLabel.textContent = 'Ch∆∞a b·∫Øt ƒë·∫ßu';
  modeLabel.textContent = '‚Äî';
  syncTableButtons();
  updateLiveStats();
})();
</script>
</body>
</html>
